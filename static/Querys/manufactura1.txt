create table analitica.dou_tabla_final_tiempos as

with cruce_p as (
    select
    t1.name as orden_pdc,
    t1.origin,
    t1.project_id,
    t1.state,
    t1.date_start_per,
    TO_CHAR(t1.date_start_per, 'YYYY-MM') AS mes_inicio,
    (t1.date_start_per >= CURRENT_DATE - INTERVAL '7 days' AND t1.date_start <= CURRENT_DATE) AS iniciado_semana,    
    t1.date_finished,
    TO_CHAR(t1.date_finished, 'YYYY-MM') AS mes_fin,
    (t1.date_finished >= CURRENT_DATE - INTERVAL '7 days' AND t1.date_finished <= CURRENT_DATE) AS terminado_semana,
    (date_finished >= date_trunc('week', current_date) 
     AND date_finished < date_trunc('week', current_date) + interval '7 days') AS terminado_esta_semana,      
    t1.create_date,
    TO_CHAR(t1.create_date, 'YYYY-MM') AS mes_creacion,
    (t1.create_date >= CURRENT_DATE - INTERVAL '7 days' AND t1.create_date <= CURRENT_DATE) AS creado_semana,                    
    t1.sale_order_id,
    t2.name as nombre_fabricante,
    case 
        when t1.product_id = 41  then 'FREIDORA'
        else upper(t4.name->>'es_ES')
    end  as producto,
    t4.tipo_proceso as tipo_producto,
    working_hours_diff(t1.date_start_per, t1.date_finished) as horas_fabricacion,
    working_hours_diff(t1.create_date, t1.date_start_per) as horas_crea_ini,
    case
        when lower(t4.name->>'es_ES') like '%base%chef%' then 'Base Chef'
        when lower(t4.name->>'es_ES') like '%baño%maria%' then 'Baño María'
        when lower(t4.name->>'es_ES') like '%campana%' then 'Campana'
        when lower(t4.name->>'es_ES') like '%carcamo%' then 'Cárcamo'
        when lower(t4.name->>'es_ES') like '%congelador%' then 'Congelador'
        when lower(t4.name->>'es_ES') like '%escurridor%loza%' then 'Escurridor Loza'
        when lower(t4.name->>'es_ES') like '%estacion%licuado%' then 'Estación de Licuado'
        when lower(t4.name->>'es_ES') like '%estacion%bar%' then 'Estación de Bar'
        when lower(t4.name->>'es_ES') like '%estanteria%industrial%' then 'Estantería industrial'
        when lower(t4.name->>'es_ES') like '%estufa%' then 'Estufa'
        when lower(t4.name->>'es_ES') like '%freidora%' then 'Freidora'
        when lower(t4.name->>'es_ES') like '%lavado%manos%' then 'Lavado de Manos'
        when lower(t4.name->>'es_ES') like '%mesa%auxiliar%' then 'Mesa Auxiliar'
        when lower(t4.name->>'es_ES') like '%mesa%lavado%' then 'Mesa de Lavado' 
        when lower(t4.name->>'es_ES') like '%mesa%isla%' then 'Mesa en Isla'
        when lower(t4.name->>'es_ES') like '%lava%traperos%' then 'Lava Traperos'
        when lower(t4.name->>'es_ES') like '%mesa%trabajo%' then 'Mesa de Trabajo'
        when lower(t4.name->>'es_ES') like '%mesa%apoyo%' then 'Mesa de Apoyo'
        when lower(t4.name->>'es_ES') like '%modulo%mixto%gas%' then 'Módulo Mixto de Cocción' 
        when lower(t4.name->>'es_ES') like '%mueble%' then 'Mueble (Carpintería)'
        when lower(t4.name->>'es_ES') like '%nevera%' then 'Nevera/Refrigerador'
        when lower(t4.name->>'es_ES') like '%refrigerador%' then 'Nevera/Refrigerador'
        when lower(t4.name->>'es_ES') like '%parrilla%' then 'Parrilla'
        when lower(t4.name->>'es_ES') like '%plancha%' then 'Plancha'
        when lower(t4.name->>'es_ES') like '%punto%pago%' then 'Punto de Pago'
        when lower(t4.name->>'es_ES') like '%repisa%' then 'Repisa'
        when lower(t4.name->>'es_ES') like '%vertical%mixta%' then 'Nevera/Refrigerador'
        when lower(t4.name->>'es_ES') like '%vitrina%' then 'Vitrina'                         
        when lower(t4.name->>'es_ES') like '%cava%' then 'Cava'
        when t1.product_id = 41  then 'Freidora'
        else 'Otro Carpintería'
    end as familia_producto
    from mrp_production t1
    left join hr_employee t2 on t1.employee_id=t2.id
    left join product_product t3 ON t1.product_id = t3.id
    left join product_template t4 ON t3.product_tmpl_id = t4.id
    where tipo_proceso <> 'log' 
)
select * from cruce_p

 